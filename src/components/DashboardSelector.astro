---
// Este componente manejará la selección y visualización de dashboards
---

---
// Este componente manejará la selección y visualización de dashboards
---

<div class="w-full mx-auto flex flex-col" style="min-height: calc(100vh - 160px);">
  <!-- Indicador del tema actual -->
  <div id="theme-indicator" class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl flex items-center gap-3">
    <div class="flex items-center gap-2">
      <div id="theme-color-indicator" class="w-4 h-4 rounded-full bg-gradient-to-r from-blue-300 to-cyan-400"></div>
      <span class="text-sm font-medium text-blue-800">Tema Activo:</span>
      <span id="theme-name" class="text-sm font-bold text-blue-900">Yalo (Tema Verde/Azul)</span>
    </div>
    <div id="theme-palette" class="flex gap-1 ml-auto">
      <div class="w-3 h-3 rounded-full" style="background-color: #bde3fa" title="#bde3fa"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #3db4f0" title="#3db4f0"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #179ce0" title="#179ce0"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #0a7cbf" title="#0a7cbf"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #09639b" title="#09639b"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #0c5480" title="#0c5480"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #10466a" title="#10466a"></div>
      <div class="w-3 h-3 rounded-full" style="background-color: #0b2c46" title="#0b2c46"></div>
    </div>
  </div>
  
  <!-- Selector de tema -->
  <div class="mb-6 p-4 bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200">
    <label for="theme-select" class="flex mb-3 text-sm font-semibold text-gray-700 items-center gap-2">
      <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path>
      </svg>
      Seleccionar Tema:
    </label>
    <div class="relative">
      <select 
        id="theme-select" 
        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base bg-white/80 backdrop-blur-sm transition-all duration-300 focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white hover:border-gray-300 appearance-none cursor-pointer"
      >
        <option value="yalo">Yalo (Tema Verde/Azul)</option>
        <option value="bipbip">BipBip (Tema Original)</option>
        <option value="bipbip-variant">BipBipVariant (Tema Rojo)</option>
        <option value="hamburguesa">Hamburguesa (Tema Ingredientes)</option>
      </select>
      <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>
  </div>
  
  <div class="w-full flex flex-col sm:flex-row gap-6 mb-6 flex-shrink-0">
    <div class="flex-1 min-w-64">
      <label for="dashboard-select" class="flex mb-3 text-sm font-semibold text-gray-700 items-center gap-2">
        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Seleccionar Dashboard:
      </label>
      <div class="relative">
        <select 
          id="dashboard-select" 
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-base bg-white/80 backdrop-blur-sm transition-all duration-300 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:bg-white hover:border-gray-300 appearance-none cursor-pointer"
        >
          <option value="">Cargando dashboards...</option>
        </select>
        <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
    </div>
    <button 
      id="show-dashboard" 
      class="px-8 py-3 text-white border-none rounded-xl text-base font-semibold cursor-pointer transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none transform hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl self-end"
      disabled
    >
      <span class="flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        Mostrar Dashboard
      </span>
    </button>
  </div>
  
  <div id="loading" class="w-full hidden flex-col items-center justify-center flex-1 p-10 bg-white/60 backdrop-blur-sm rounded-2xl border-2 border-dashed border-gray-300 min-h-48 shadow-lg">
    <div class="relative">
      <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
      <div class="absolute inset-0 w-12 h-12 border-4 border-transparent border-b-purple-400 rounded-full animate-spin animation-delay-2000"></div>
    </div>
    <p class="text-gray-600 text-base m-0 font-medium">Cargando dashboard...</p>
    <div class="mt-2 flex gap-1">
      <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
      <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce animation-delay-200"></div>
      <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce animation-delay-400"></div>
    </div>
  </div>
  
  <div id="dashboard-container" class="p-4 w-full bg-white/80 backdrop-blur-lg rounded-2xl shadow-2xl border border-white/20 overflow-auto relative hidden" style="min-height: 600px; max-height: none;">
    <!-- El componente se creará dinámicamente aquí -->
  </div>
  
  <div id="error-message" class="w-full p-4 bg-red-50/90 backdrop-blur-sm border-l-4 border-red-500 rounded-r-xl text-red-700 text-sm mt-4 hidden shadow-lg">
    <div class="flex items-center gap-3">
      <div class="flex-shrink-0">
        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div class="flex-1">
        <span class="font-medium">Error:</span>
        <span id="error-text" class="ml-1"></span>
      </div>
    </div>
  </div>
</div>

<script>
  // API Key desde variables de entorno
  const API_KEY = import.meta.env.PUBLIC_EMBEDDABLE_API_KEY;
  const API_BASE_URL = 'https://api.us.embeddable.com/api/v1';
  
  // Definición de todos los temas disponibles
  const THEMES = {
    yalo: {
      name: 'Yalo (Tema Verde/Azul)',
      client: 'yalo',
      theme: {
        colors: [
          '#bde3fa', '#3db4f0', '#179ce0', '#0a7cbf',
          '#09639b', '#0c5480', '#10466a', '#0b2c46'
        ],
        brand: {
          primary: '#bde3fa',
          secondary: '#09639b',
          accent: '#0b2c46'
        }
      },
      background: '#fff'
    },
    bipbip: {
      name: 'BipBip (Tema Original)',
      client: 'bipbip',
      theme: {
        colors: [
          '#6778DE', '#FF997C', '#9EA4F4', '#B8B8D1',
          '#FF6B6C', '#FFC145', '#9DC7FF', '#FF805B',
          '#CD9FFF', '#E6DEDE', '#FFA6A6', '#fb0021'
        ],
        brand: {
          primary: '#6778DE',
          secondary: '#FFA6A6',
          accent: '#fb0021'
        }
      },
      background: '#fff'
    },
    'bipbip-variant': {
      name: 'BipBipVariant (Tema Rojo)',
      client: 'bipbip-variant',
      theme: {
        colors: [
          '#fb0021', '#ff4d6d', '#ff758f', '#ff8fa3',
          '#ffb3c6', '#ffccd5', '#ffdde4', '#fff0f3'
        ],
        brand: {
          primary: '#fb0021',
          secondary: '#ff4d6d',
          accent: '#ffb3c6'
        }
      },
      background: '#fff'
    },
    hamburguesa: {
      name: 'Hamburguesa (Tema Ingredientes)',
      client: 'hamburguesa',
      theme: {
        colors: [
          '#f5e6b2', // Pan superior
          '#d4a373', // Pan inferior
          '#e63946', // Tomate
          '#f1c40f', // Queso
          '#27ae60', // Lechuga
          '#784421', // Carne
          '#a0522d', // Tocino
          '#fffbe7'  // Semillas de sésamo
        ],
        brand: {
          primary: '#f5e6b2',
          secondary: '#27ae60',
          accent: '#e63946'
        }
      },
      background: '#fff'
    }
  };
  
  // Variable para el tema actual
  let currentTheme = 'yalo';
  
  // Tipos de datos
  interface Dashboard {
    id: string;
    name: string;
    lastPublishedAt: Record<string, string>;
  }
  
  interface DashboardsResponse {
    embeddables: Dashboard[];
  }
  
  interface TokenResponse {
    token: string;
  }
  
  let dashboards: Dashboard[] = [];
  
  // Elementos del DOM
  const selectElement = document.getElementById('dashboard-select') as HTMLSelectElement | null;
  const showButton = document.getElementById('show-dashboard') as HTMLButtonElement | null;
  const loadingElement = document.getElementById('loading') as HTMLElement | null;
  const dashboardContainer = document.getElementById('dashboard-container') as HTMLElement | null;
  let embeddableComponent: HTMLElement | null = null;
  const errorMessage = document.getElementById('error-message') as HTMLElement | null;
  
  // Elementos del tema
  const themeSelect = document.getElementById('theme-select') as HTMLSelectElement | null;
  const themeIndicator = document.getElementById('theme-indicator') as HTMLElement | null;
  const themeName = document.getElementById('theme-name') as HTMLElement | null;
  const themePalette = document.getElementById('theme-palette') as HTMLElement | null;
  const themeColorIndicator = document.getElementById('theme-color-indicator') as HTMLElement | null;
  
  // Función para obtener el tema actual
  function getCurrentTheme() {
    return THEMES[currentTheme as keyof typeof THEMES];
  }
  
  // Función para actualizar la interfaz del tema
  function updateThemeUI() {
    const theme = getCurrentTheme();
    if (!theme) return;
    
    // Actualizar nombre del tema
    if (themeName) {
      themeName.textContent = theme.name;
    }
    
    // Actualizar indicador de color
    if (themeColorIndicator) {
      themeColorIndicator.style.background = `linear-gradient(135deg, ${theme.theme.brand.primary} 0%, ${theme.theme.brand.secondary} 100%)`;
    }
    
    // Actualizar paleta de colores
    if (themePalette) {
      themePalette.innerHTML = theme.theme.colors.map(color => 
        `<div class="w-3 h-3 rounded-full" style="background-color: ${color}" title="${color}"></div>`
      ).join('');
    }
    
    // Actualizar fondo del indicador
    if (themeIndicator) {
      const primary = theme.theme.brand.primary;
      const secondary = theme.theme.brand.secondary;
      themeIndicator.style.background = `linear-gradient(135deg, ${primary}20 0%, ${secondary}20 100%)`;
      themeIndicator.style.borderColor = primary;
    }
    
    // Actualizar botón con colores del tema
    if (showButton) {
      const primary = theme.theme.brand.primary;
      const secondary = theme.theme.brand.secondary;
      const accent = theme.theme.brand.accent;
      
      showButton.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 50%, ${accent} 100%)`;
      showButton.style.color = 'white';
      
      // Actualizar eventos hover
      showButton.onmouseenter = () => {
        showButton.style.background = `linear-gradient(135deg, ${secondary} 0%, ${accent} 50%, ${primary} 100%)`;
      };
      showButton.onmouseleave = () => {
        showButton.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 50%, ${accent} 100%)`;
      };
    }
    
    console.log(`🎨 Tema actualizado a: ${theme.name}`);
  }
  
  // Función para mostrar/ocultar elementos
  function toggleElement(element: HTMLElement | null, show: boolean): void {
    if (!element) return;
    
    if (show) {
      element.classList.remove('hidden');
      // Agregar flex para el loading
      if (element.id === 'loading') {
        element.classList.add('flex');
      }
    } else {
      element.classList.add('hidden');
      // Remover flex para el loading
      if (element.id === 'loading') {
        element.classList.remove('flex');
      }
    }
  }
  
  // Función para ajustar el contenedor dinámicamente
  function setupDynamicContainer(): void {
    if (!dashboardContainer) return;
    
    // Remover cualquier restricción de altura
    dashboardContainer.style.maxHeight = 'none';
    dashboardContainer.style.height = 'auto';
    
    console.log('Configurando contenedor dinámico sin restricciones de altura');
  }
  function showError(message: string): void {
    if (!errorMessage) return;
    
    const errorText = document.getElementById('error-text');
    if (errorText) {
      errorText.textContent = message;
    } else {
      errorMessage.textContent = message;
    }
    toggleElement(errorMessage, true);
    toggleElement(loadingElement, false);
    
    // Add shake animation
    errorMessage.classList.add('animate-shake');
    setTimeout(() => {
      errorMessage.classList.remove('animate-shake');
    }, 500);
  }
  
  // Función para obtener la lista de dashboards
  async function fetchDashboards(): Promise<Dashboard[]> {
    try {
      const response = await fetch(`${API_BASE_URL}/embeddables`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }
      
      const data: DashboardsResponse = await response.json();
      return data.embeddables || [];
    } catch (error) {
      console.error('Error fetching dashboards:', error);
      const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
      showError('Error al cargar la lista de dashboards: ' + errorMessage);
      return [];
    }
  }
  
  // Función para obtener el token de un dashboard específico
  async function fetchDashboardToken(embeddableId: string): Promise<string | null> {
    try {
      console.log('Solicitando token para embeddableId:', embeddableId);
      
      // Aquí necesitaré los parámetros específicos que me proporciones
      const tokenRequest = {
        embeddableId: embeddableId,
        expiryInSeconds: 60 * 60 * 24, // 24 horas
        securityContext: {
          // Agregar contexto de seguridad según tus necesidades
        },
        user: 'erick.alvarado@cit.hn', // Identificador único del usuario
        environment: 'default' // Ambiente por defecto
      };
      
      console.log('Datos de la petición del token:', tokenRequest);
      
      const response = await fetch(`${API_BASE_URL}/security-token`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify(tokenRequest)
      });
      
      console.log('Respuesta del servidor:', response.status, response.statusText);
      
      if (!response.ok) {
        // Intentar obtener más detalles del error
        const errorText = await response.text();
        console.error('Error del servidor:', errorText);
        throw new Error(`Error ${response.status}: ${response.statusText} - ${errorText}`);
      }
      
      const data: TokenResponse = await response.json();
      console.log('Token recibido exitosamente');
      return data.token;
    } catch (error) {
      console.error('Error completo fetching dashboard token:', error);
      const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
      showError('Error al obtener el token del dashboard: ' + errorMessage);
      return null;
    }
  }
  
  // Función para mostrar el dashboard
  async function showDashboard(): Promise<void> {
    if (!selectElement) {
      showError('Error: Elemento select no encontrado');
      return;
    }
    
    const selectedDashboardId = selectElement.value;
    
    if (!selectedDashboardId) {
      showError('Por favor selecciona un dashboard');
      return;
    }
    
    // Mostrar loading
    toggleElement(loadingElement, true);
    toggleElement(errorMessage, false);
    toggleElement(dashboardContainer, false);
    
    console.log('Obteniendo token para dashboard:', selectedDashboardId);
    
    // Obtener token
    const token = await fetchDashboardToken(selectedDashboardId);
    
    console.log('Token obtenido:', token ? 'Sí' : 'No', token?.substring(0, 50) + '...');
    
    if (token && dashboardContainer) {
      console.log('Creando componente embeddable dinámicamente...');
      
      // Limpiar el contenedor
      dashboardContainer.innerHTML = '';
      
      // Obtener el tema actual
      const selectedTheme = getCurrentTheme();
      
      console.log('Usando tema de contexto:', selectedTheme.name, selectedTheme);
      
      // Crear el componente em-beddable dinámicamente
      embeddableComponent = document.createElement('em-beddable');
      embeddableComponent.setAttribute('token', token);
      
      // Agregar el client-context como atributo JSON
      embeddableComponent.setAttribute('client-context', JSON.stringify({
        client: selectedTheme.client,
        theme: selectedTheme.theme
      }));
      
      embeddableComponent.className = 'block w-full border-0';
      embeddableComponent.style.cssText = 'height: auto; min-height: 800px; width: 100%;';
      
      // Agregar el componente al contenedor
      dashboardContainer.appendChild(embeddableComponent);
      
      console.log('Componente embeddable creado con tema', selectedTheme.name, 'y agregado al DOM');
      console.log('Client Context aplicado:', JSON.stringify({
        client: selectedTheme.client,
        theme: selectedTheme.theme
      }, null, 2));
      
      // Verificar que el atributo se estableció correctamente
      const contextAttribute = embeddableComponent.getAttribute('client-context');
      console.log('Client Context verificado en el DOM:', contextAttribute);
      
      // Event listener para verificar cuando el componente se carga
      embeddableComponent.addEventListener('load', () => {
        console.log('✅ Componente embeddable cargado con tema', selectedTheme.name);
      });
      
      // Evento personalizado para debug
      embeddableComponent.addEventListener('error', (event) => {
        console.error('❌ Error en componente embeddable:', event);
      });
      
      // Verificar que el atributo se estableció correctamente
      const appliedContext = embeddableComponent.getAttribute('client-context');
      console.log('Client Context verificado en el DOM:', appliedContext);
      
      // Event listener para verificar cuando el componente se carga
      embeddableComponent.addEventListener('load', () => {
        console.log('✅ Componente embeddable cargado con tema Yalo');
      });
      
      // Evento personalizado para debug
      embeddableComponent.addEventListener('error', (event) => {
        console.error('❌ Error en componente embeddable:', event);
      });
      
      // Función simplificada para ajustar la altura
      const adjustHeight = () => {
        if (embeddableComponent) {
          // Remover cualquier restricción de altura del contenedor
          dashboardContainer.style.height = 'auto';
          dashboardContainer.style.maxHeight = 'none';
          
          console.log('Altura del contenedor ajustada para permitir crecimiento libre');
        }
      };
      
      // Ajustar altura después de un breve delay
      setTimeout(adjustHeight, 500);
      
      // Mostrar el dashboard
      toggleElement(loadingElement, false);
      toggleElement(dashboardContainer, true);
      
    } else if (!dashboardContainer) {
      showError('Error: Contenedor del dashboard no encontrado');
      showError('Error: Componente embeddable no encontrado');
    } else {
      showError('Error: No se pudo obtener el token del dashboard');
    }
  }
  
  // Función para inicializar la aplicación
  async function initializeApp(): Promise<void> {
    if (!selectElement || !showButton) {
      showError('Error: Elementos de la interfaz no encontrados');
      return;
    }
    
    // Configurar contenedor dinámico
    setupDynamicContainer();
    
    // Cargar lista de dashboards
    dashboards = await fetchDashboards();
    
    if (dashboards.length > 0) {
      // Limpiar el select
      selectElement.innerHTML = '<option value="">Selecciona un dashboard...</option>';
      
      // Agregar opciones al select
      dashboards.forEach((dashboard: Dashboard) => {
        const option = document.createElement('option');
        option.value = dashboard.id;
        option.textContent = dashboard.name;
        selectElement?.appendChild(option);
      });
      
      // Habilitar el botón cuando se seleccione un dashboard
      selectElement.addEventListener('change', () => {
        if (showButton && selectElement) {
          showButton.disabled = !selectElement.value;
        }
      });
      
      // Habilitar el botón
      showButton.disabled = false;
    } else {
      selectElement.innerHTML = '<option value="">No hay dashboards disponibles</option>';
    }
  }
  
  // Event listeners
  if (showButton) {
    showButton.addEventListener('click', showDashboard);
  }
  
  // Event listener para el selector de temas
  if (themeSelect) {
    themeSelect.addEventListener('change', (event) => {
      const target = event.target as HTMLSelectElement;
      currentTheme = target.value;
      updateThemeUI();
      
      // Si hay un dashboard mostrado, actualizarlo con el nuevo tema
      if (embeddableComponent && !dashboardContainer?.classList.contains('hidden')) {
        console.log('🔄 Cambiando tema del dashboard actual...');
        showDashboard(); // Recargar el dashboard con el nuevo tema
      }
    });
  }
  
  // Inicializar cuando se cargue la página
  document.addEventListener('DOMContentLoaded', () => {
    updateThemeUI(); // Inicializar la UI del tema
    initializeApp();
  });
  
  // Manejar redimensionamiento de ventana (mantener sin restricciones)
  window.addEventListener('resize', () => {
    if (dashboardContainer && !dashboardContainer.classList.contains('hidden')) {
      // Asegurar que no haya restricciones de altura
      dashboardContainer.style.maxHeight = 'none';
      dashboardContainer.style.height = 'auto';
    }
  });
</script>
